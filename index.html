<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ú–∞–≥–∞–∑–∏–Ω –ú–∞–∫—Å–∞–ª–∏–Ω–∞</title>

  <!-- Manifest -->
  <link rel="manifest" href="manifest.json" />

  <!-- –ò–∫–æ–Ω–∫–∞ -->
  <link rel="icon" href="icon.png" type="image/png" />

  <!-- –°—Ç–∏–ª–∏ -->
  <link rel="stylesheet" href="style.css" />

  <!-- PWA -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log("Service Worker –ø–æ–¥–∫–ª—é—á–µ–Ω"))
        .catch(err => console.error("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Service Worker:", err));
    }
  </script>
</head>
<body>

  <header>
    <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω –ú–∞–∫—Å–∞–ª–∏–Ω–∞</h1>
    <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤.</p>
  </header>

  <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
  <button id="installBtn" style="display:none; position:fixed; bottom:20px; right:20px; padding:10px 15px; background:#8e44ad; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">
    üì≤ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
  </button>

  <nav>
    <h2>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
    <select id="categorySelect">
      <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
    </select>

    <h2>–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
    <select id="subcategorySelect" disabled>
      <option value="">–í—Å–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
    </select>
  </nav>

  <main>
    <div id="products">
      <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</p>
    </div>
  </main>

  <footer>
    <h3>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h3>
    <p>üìû WhatsApp: <a href="https://wa.me/79161234567" target="_blank">+7 916 123-45-67</a></p>
    <p>üìß Email: <a href="mailto:info@maksalina.ru">info@maksalina.ru</a></p>
    <p>üìç –ê–¥—Ä–µ—Å: –≥. –ú–æ—Å–∫–≤–∞, —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, –¥. 10</p>
    <p>&copy; 2025 –ú–∞–≥–∞–∑–∏–Ω –ú–∞–∫—Å–∞–ª–∏–Ω–∞</p>
  </footer>

  <script>
    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'block';
    });

    installBtn.addEventListener('click', () => {
      installBtn.style.display = 'none';
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(() => {
        deferredPrompt = null;
      });
    });

    const sheetId = "1uvZDDq7y3D73InwHYQ4vKqmhHXGtK9KjdRcVXzm5KAk"; // ID —Ç–≤–æ–µ–π —Ç–∞–±–ª–∏—Ü—ã
    const sheetName = "–õ–∏—Å—Ç1";
    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${sheetName}`;

    let products = [];

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ Google Sheets
    fetch(url)
      .then(res => res.text())
      .then(rep => {
        const jsonData = JSON.parse(rep.substr(47).slice(0, -2));
        const rows = jsonData.table.rows;
        products = rows.map(row => {
          const cells = row.c;
          return {
            category: cells[0]?.v || "",
            subcategory: cells[1]?.v || "",
            name: cells[2]?.v || "",
            description: cells[3]?.v || "",
            price: cells[4]?.v || "",
            photo: cells[5]?.v || ""
          };
        });

        fillCategoryOptions();
        renderProducts(products);
      })
      .catch(err => {
        document.getElementById('products').innerHTML = "<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤</p>";
        console.error(err);
      });

    // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å–µ–ª–µ–∫—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    function fillCategoryOptions() {
      const categorySelect = document.getElementById("categorySelect");
      const categories = [...new Set(products.map(p => p.category).filter(c => c))].sort();

      categories.forEach(cat => {
        const option = document.createElement("option");
        option.value = cat;
        option.textContent = cat;
        categorySelect.appendChild(option);
      });

      categorySelect.addEventListener("change", () => {
        const selectedCat = categorySelect.value;
        fillSubcategoryOptions(selectedCat);
        filterAndRender();
      });
    }

    // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å–µ–ª–µ–∫—Ç –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π
    function fillSubcategoryOptions(category) {
      const subcategorySelect = document.getElementById("subcategorySelect");
      subcategorySelect.innerHTML = '<option value="">–í—Å–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';

      if (!category) {
        subcategorySelect.disabled = true;
        filterAndRender();
        return;
      }

      subcategorySelect.disabled = false;
      const subcategories = [...new Set(products
        .filter(p => p.category === category)
        .map(p => p.subcategory)
        .filter(sc => sc))].sort();

      subcategories.forEach(subcat => {
        const option = document.createElement("option");
        option.value = subcat;
        option.textContent = subcat;
        subcategorySelect.appendChild(option);
      });

      subcategorySelect.addEventListener("change", filterAndRender);
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
    function filterAndRender() {
      const selectedCat = document.getElementById("categorySelect").value;
      const selectedSubcat = document.getElementById("subcategorySelect").value;

      let filtered = products;

      if (selectedCat) {
        filtered = filtered.filter(p => p.category === selectedCat);
      }
      if (selectedSubcat) {
        filtered = filtered.filter(p => p.subcategory === selectedSubcat);
      }

      renderProducts(filtered);
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
    function renderProducts(items) {
      const container = document.getElementById("products");
      container.innerHTML = "";

      if (items.length === 0) {
        container.innerHTML = "<p>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>";
        return;
      }

      items.forEach(item => {
        const block = document.createElement("div");
        block.className = "product";

        block.innerHTML = `
          <img src="${item.photo}" alt="${item.name}" />
          <h2>${item.name}</h2>
          <p><strong>${item.price} ‚ÇΩ</strong></p>
          <p>${item.description}</p>
          <p><em>${item.category} / ${item.subcategory}</em></p>
          <a href="https://wa.me/79161234567?text=–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ,%20–∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç%20—Ç–æ–≤–∞—Ä:%20${encodeURIComponent(item.name)}" target="_blank" class="whatsapp-button">–ù–∞–ø–∏—Å–∞—Ç—å –≤ WhatsApp</a>
        `;

        container.appendChild(block);
      });
    }
  </script>

</body>
</html>